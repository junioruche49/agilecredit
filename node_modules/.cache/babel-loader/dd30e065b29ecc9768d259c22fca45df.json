{"ast":null,"code":"var _jsxFileName = \"/Users/mac/Documents/react app/agilecreditportal/src/pages/PaymentCallback.tsx\";\nimport React, { useState, useEffect, useCallback } from \"react\";\nimport { useLocation, withRouter } from \"react-router\";\nimport { useHistory } from \"react-router-dom\";\nimport useProfileStore from \"../stores/profileStore\";\nimport { useMutation } from \"react-query\";\nimport useAuthStore from \"../stores/authStore\";\nimport { addCardToProfile } from \"../clients/cards\";\nimport { validatePayment } from \"../clients/payments\";\n\nfunction useQueryParams() {\n  return new URLSearchParams(useLocation().search);\n}\n\nconst PaymentCallback = props => {\n  let referrerData = props.location.referrerData;\n\n  if (referrerData === null || referrerData === \"\" || referrerData === undefined) {\n    props.history.push(\"/pay\");\n  }\n\n  const profile = useProfileStore(state => state.data);\n  const [isLoading, setLoading] = useState(false);\n  const [isPaymentValid, setIsPaymentValid] = useState(false);\n  const [verifyTrxResponse, setVerifyTrxResponse] = useState();\n  const [errorMsg, setErrorMsg] = useState([]);\n\n  const updateErrors = errors => {\n    setErrorMsg(Object.values(errors).flat());\n  };\n\n  const [addCardErrorResponse, setAddCardErrorResponse] = useState();\n  let query = useQueryParams();\n  const history = useHistory();\n  const token = useAuthStore(state => state.accessToken);\n  const confirmPaymentEntry = useCallback(async () => {\n    let values = {\n      email: profile === null || profile === void 0 ? void 0 : profile.e_mail,\n      amount: referrerData === null || referrerData === void 0 ? void 0 : referrerData.amount,\n      user_id: profile === null || profile === void 0 ? void 0 : profile.user_id,\n      payment_type: referrerData === null || referrerData === void 0 ? void 0 : referrerData.payment_type,\n      description: (referrerData === null || referrerData === void 0 ? void 0 : referrerData.payment_type) === 0 ? \"Card Pre-auth charge\" : \"Repayment with new card\",\n      item_id: referrerData === null || referrerData === void 0 ? void 0 : referrerData.item_id,\n      reference: referrerData === null || referrerData === void 0 ? void 0 : referrerData.reference\n    };\n    setLoading(true);\n\n    try {\n      const {\n        message,\n        data,\n        success,\n        status\n      } = await validatePayment(token, values);\n\n      if (success === false || status === false) {\n        let msg = [];\n        msg.push(message);\n        setErrorMsg(msg);\n        setLoading(false);\n        return;\n      }\n\n      setLoading(true);\n      setIsPaymentValid(status);\n      setVerifyTrxResponse(data);\n      setErrorMsg([]);\n      setLoading(false);\n    } catch (error) {\n      setLoading(false);\n\n      if (error && !error.response) {\n        let msg = [];\n        msg.push(\"Network Error, Check Your Internet Connection\");\n        setErrorMsg(msg);\n        return;\n      }\n\n      if (error && (error.response.status === 500 || error.response.status === 404 || error.response.status === 401)) {\n        let msg = [];\n        msg.push(error.response.data.message);\n        setErrorMsg(msg);\n        return;\n      }\n\n      const {\n        response: {\n          data\n        }\n      } = error;\n      data.errors && updateErrors(data.errors);\n    }\n  }, [profile]);\n  useEffect(() => {\n    if ((profile === null || profile === void 0 ? void 0 : profile.e_mail) && !verifyTrxResponse) {\n      confirmPaymentEntry();\n    }\n\n    if ((profile === null || profile === void 0 ? void 0 : profile.e_mail) && isPaymentValid) {\n      if ((verifyTrxResponse === null || verifyTrxResponse === void 0 ? void 0 : verifyTrxResponse.payment_type) === 0) addCard();\n\n      if ((verifyTrxResponse === null || verifyTrxResponse === void 0 ? void 0 : verifyTrxResponse.payment_type) === 2) {\n        props.history.replace({\n          pathname: \"/pay/success\",\n          referrerData: {\n            amount: verifyTrxResponse === null || verifyTrxResponse === void 0 ? void 0 : verifyTrxResponse.amount,\n            loan_id: verifyTrxResponse === null || verifyTrxResponse === void 0 ? void 0 : verifyTrxResponse.item_id\n          }\n        });\n      }\n    }\n  }, [verifyTrxResponse, profile]);\n  const [addCardMutation, {\n    isLoading: isAddCardLoading,\n    error: addCardError,\n    data: addCardResponse\n  }] = useMutation(addCardToProfile);\n  const addCard = useCallback(async () => {\n    try {\n      const {\n        message,\n        data,\n        success\n      } = await addCardMutation({\n        token,\n        email: profile.e_mail,\n        transaction_ref: verifyTrxResponse === null || verifyTrxResponse === void 0 ? void 0 : verifyTrxResponse.reference\n      });\n\n      if (!success) {\n        throw new Error(message);\n      }\n\n      props.history.replace(\"/cards\", {\n        message\n      });\n    } catch (err) {\n      console.log(err);\n      setAddCardErrorResponse(err.message);\n    }\n  }, [profile, token, query, addCardMutation, history]);\n\n  if (isLoading || isAddCardLoading || !profile.e_mail) {\n    return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(\"div\", {\n      className: \"w-11/12 bg-white rounded py-12 shadow-lg m-auto px-8 relative mt-20\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 143,\n        columnNumber: 9\n      }\n    }, /*#__PURE__*/React.createElement(\"img\", {\n      src: \"/img/loading-gif.gif\",\n      alt: \"\",\n      className: \"w-1/8 m-auto py-10\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 144,\n        columnNumber: 11\n      }\n    }), /*#__PURE__*/React.createElement(\"h6\", {\n      className: \"m-auto text-lg text-gray-700 text-center\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 149,\n        columnNumber: 11\n      }\n    }, \"Please wait. We are verifying the transaction...\")));\n  }\n\n  if (errorMsg.length > 0 || addCardError || verifyTrxResponse && !verifyTrxResponse.status || addCardResponse && !addCardResponse.status) {\n    return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(\"main\", {\n      className: \"md:pl-12\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 165,\n        columnNumber: 9\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      className: \"flex \",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 166,\n        columnNumber: 11\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      className: \"w-full \",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 167,\n        columnNumber: 13\n      }\n    }, /*#__PURE__*/React.createElement(\"br\", {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 168,\n        columnNumber: 15\n      }\n    }), errorMsg.length ? /*#__PURE__*/React.createElement(\"div\", {\n      className: \"w-11/12 bg-red-100 border-t-4 border-red-500 rounded-b text-red-900 px-4 py-3 shadow-md mb-5 m-auto md:m-0 md:mb-2\",\n      role: \"alert\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 170,\n        columnNumber: 17\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      className: \"flex\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 174,\n        columnNumber: 19\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      className: \"py-1\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 175,\n        columnNumber: 21\n      }\n    }, /*#__PURE__*/React.createElement(\"svg\", {\n      className: \"fill-current h-6 w-6 text-red-500 mr-4\",\n      xmlns: \"http://www.w3.org/2000/svg\",\n      viewBox: \"0 0 20 20\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 176,\n        columnNumber: 23\n      }\n    }, /*#__PURE__*/React.createElement(\"path\", {\n      d: \"M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zm12.73-1.41A8 8 0 1 0 4.34 4.34a8 8 0 0 0 11.32 11.32zM9 11V9h2v6H9v-4zm0-6h2v2H9V5z\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 181,\n        columnNumber: 25\n      }\n    }))), /*#__PURE__*/React.createElement(\"div\", {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 184,\n        columnNumber: 21\n      }\n    }, /*#__PURE__*/React.createElement(\"ul\", {\n      style: {\n        listStyleType: \"none\"\n      },\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 187,\n        columnNumber: 23\n      }\n    }, errorMsg.map((error, i) => /*#__PURE__*/React.createElement(\"li\", {\n      key: i,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 189,\n        columnNumber: 27\n      }\n    }, error)))))) : \"\", /*#__PURE__*/React.createElement(\"div\", {\n      className: \"relative w-11/12 bg-white rounded py-12 shadow-lg border-b-4 border-blue-700 md:border-none mb-20 m-auto md:m-0 mt-12 md:mt-0\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 198,\n        columnNumber: 15\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      className: \"w-full m-auto mb-6\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 199,\n        columnNumber: 17\n      }\n    }, /*#__PURE__*/React.createElement(\"img\", {\n      src: \"/img/error-icon.svg\",\n      alt: \"\",\n      className: \"w-2/4 md:w-1/4 m-auto\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 200,\n        columnNumber: 19\n      }\n    })), /*#__PURE__*/React.createElement(\"div\", {\n      className: \"w-3/4 md:w-2/4 m-auto\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 206,\n        columnNumber: 17\n      }\n    }, /*#__PURE__*/React.createElement(\"p\", {\n      className: \"text-gray-700 font-medium text-center\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 207,\n        columnNumber: 19\n      }\n    }, /*#__PURE__*/React.createElement(\"span\", {\n      className: \"text-red-600\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 208,\n        columnNumber: 21\n      }\n    }, \"Oops! An error has occured.\"), \" \", /*#__PURE__*/React.createElement(\"br\", {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 211,\n        columnNumber: 21\n      }\n    }), verifyTrxResponse && verifyTrxResponse.status === false ? verifyTrxResponse.message : \"\", addCardError ? addCardError.response.status + \" - \" + addCardError.response.data.message + \" \" + addCardErrorResponse : \"\", addCardResponse && addCardResponse.status === false ? +\" - \" + addCardResponse.message : \"\", addCardErrorResponse ? addCardErrorResponse : null)), /*#__PURE__*/React.createElement(\"div\", {\n      className: \"w-full m-auto mt-10\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 228,\n        columnNumber: 17\n      }\n    }, /*#__PURE__*/React.createElement(\"button\", {\n      onClick: () => props.history.replace(\"/\"),\n      className: \"flex w-2/4 md:w-1/4 shadow-xl text-xl font-light text-white justify-center py-4 md:py-3 items-center bg-gray-800 hover:bg-gray-700 rounded-md m-auto transition-colors duration-150 ease-in-out\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 229,\n        columnNumber: 19\n      }\n    }, /*#__PURE__*/React.createElement(\"svg\", {\n      className: \"mr-2 -mt-1\",\n      width: \"18\",\n      height: \"18\",\n      viewBox: \"0 0 18 18\",\n      fill: \"none\",\n      xmlns: \"http://www.w3.org/2000/svg\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 233,\n        columnNumber: 21\n      }\n    }, /*#__PURE__*/React.createElement(\"g\", {\n      id: \"chevron_left_24px\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 241,\n        columnNumber: 23\n      }\n    }, /*#__PURE__*/React.createElement(\"path\", {\n      id: \"icon/navigation/chevron_left_24px\",\n      d: \"M15.705 16.59L11.125 12L15.705 7.41L14.295 6L8.29498 12L14.295 18L15.705 16.59Z\",\n      fill: \"white\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 242,\n        columnNumber: 25\n      }\n    }))), /*#__PURE__*/React.createElement(\"span\", {\n      className: \"text-sm xl:text-lg lg:text-sm pr-2\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 249,\n        columnNumber: 21\n      }\n    }, \"Back to home\"))))))));\n  }\n\n  return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(\"main\", {\n    className: \"md:pl-12\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 264,\n      columnNumber: 7\n    }\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    className: \"flex \",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 265,\n      columnNumber: 9\n    }\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    className: \"w-full \",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 266,\n      columnNumber: 11\n    }\n  }, /*#__PURE__*/React.createElement(\"br\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 267,\n      columnNumber: 13\n    }\n  }), /*#__PURE__*/React.createElement(\"div\", {\n    className: \"relative w-11/12 bg-white rounded py-12 shadow-lg border-b-4 border-blue-700 md:border-none mb-20 m-auto md:m-0 mt-12 md:mt-0\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 268,\n      columnNumber: 13\n    }\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    className: \"w-full m-auto mb-6\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 269,\n      columnNumber: 15\n    }\n  }, /*#__PURE__*/React.createElement(\"img\", {\n    src: \"/img/error-icon.svg\",\n    alt: \"\",\n    className: \"w-2/4 md:w-1/4 m-auto\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 270,\n      columnNumber: 17\n    }\n  })), /*#__PURE__*/React.createElement(\"div\", {\n    className: \"w-3/4 md:w-2/4 m-auto\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 276,\n      columnNumber: 15\n    }\n  }, /*#__PURE__*/React.createElement(\"p\", {\n    className: \"text-gray-700 font-medium text-center\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 277,\n      columnNumber: 17\n    }\n  }, /*#__PURE__*/React.createElement(\"span\", {\n    className: \"text-red-600\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 278,\n      columnNumber: 19\n    }\n  }, \"Fatal exception. Please reach out to the administrator immediately! Payment ref: \", referrerData === null || referrerData === void 0 ? void 0 : referrerData.reference))))))));\n};\n\nexport default withRouter(PaymentCallback);","map":{"version":3,"sources":["/Users/mac/Documents/react app/agilecreditportal/src/pages/PaymentCallback.tsx"],"names":["React","useState","useEffect","useCallback","useLocation","withRouter","useHistory","useProfileStore","useMutation","useAuthStore","addCardToProfile","validatePayment","useQueryParams","URLSearchParams","search","PaymentCallback","props","referrerData","location","undefined","history","push","profile","state","data","isLoading","setLoading","isPaymentValid","setIsPaymentValid","verifyTrxResponse","setVerifyTrxResponse","errorMsg","setErrorMsg","updateErrors","errors","Object","values","flat","addCardErrorResponse","setAddCardErrorResponse","query","token","accessToken","confirmPaymentEntry","email","e_mail","amount","user_id","payment_type","description","item_id","reference","message","success","status","msg","error","response","addCard","replace","pathname","loan_id","addCardMutation","isAddCardLoading","addCardError","addCardResponse","transaction_ref","Error","err","console","log","length","listStyleType","map","i"],"mappings":";AAAA,OAAOA,KAAP,IAAgBC,QAAhB,EAA0BC,SAA1B,EAAqCC,WAArC,QAAwD,OAAxD;AACA,SAASC,WAAT,EAAsBC,UAAtB,QAAwC,cAAxC;AACA,SAASC,UAAT,QAA2B,kBAA3B;AACA,OAAOC,eAAP,MAA4B,wBAA5B;AACA,SAAmBC,WAAnB,QAAsC,aAAtC;AACA,OAAOC,YAAP,MAAyB,qBAAzB;AACA,SAAiCC,gBAAjC,QAAyD,kBAAzD;AACA,SAASC,eAAT,QAAgC,qBAAhC;;AAEA,SAASC,cAAT,GAA0B;AACxB,SAAO,IAAIC,eAAJ,CAAoBT,WAAW,GAAGU,MAAlC,CAAP;AACD;;AAED,MAAMC,eAAe,GAAIC,KAAD,IAAgB;AAEtC,MAAIC,YAAY,GAAGD,KAAK,CAACE,QAAN,CAAeD,YAAlC;;AACA,MACEA,YAAY,KAAK,IAAjB,IACAA,YAAY,KAAK,EADjB,IAEAA,YAAY,KAAKE,SAHnB,EAIE;AACAH,IAAAA,KAAK,CAACI,OAAN,CAAcC,IAAd,CAAmB,MAAnB;AACD;;AAED,QAAMC,OAAY,GAAGf,eAAe,CAAEgB,KAAD,IAAWA,KAAK,CAACC,IAAlB,CAApC;AACA,QAAM,CAACC,SAAD,EAAYC,UAAZ,IAA0BzB,QAAQ,CAAC,KAAD,CAAxC;AACA,QAAM,CAAC0B,cAAD,EAAiBC,iBAAjB,IAAsC3B,QAAQ,CAAC,KAAD,CAApD;AACA,QAAM,CAAC4B,iBAAD,EAAoBC,oBAApB,IAAiD7B,QAAQ,EAA/D;AACA,QAAM,CAAC8B,QAAD,EAAWC,WAAX,IAA0B/B,QAAQ,CAAC,EAAD,CAAxC;;AACA,QAAMgC,YAAY,GAAIC,MAAD,IAAgB;AACnCF,IAAAA,WAAW,CAACG,MAAM,CAACC,MAAP,CAAcF,MAAd,EAAsBG,IAAtB,EAAD,CAAX;AACD,GAFD;;AAIA,QAAM,CAACC,oBAAD,EAAuBC,uBAAvB,IAAkDtC,QAAQ,EAAhE;AAEA,MAAIuC,KAAK,GAAG5B,cAAc,EAA1B;AAEA,QAAMQ,OAAO,GAAGd,UAAU,EAA1B;AAEA,QAAMmC,KAAK,GAAGhC,YAAY,CAAEc,KAAD,IAAWA,KAAK,CAACmB,WAAlB,CAA1B;AAEA,QAAMC,mBAAmB,GAAGxC,WAAW,CAAC,YAAY;AAClD,QAAIiC,MAAM,GAAG;AACXQ,MAAAA,KAAK,EAAEtB,OAAF,aAAEA,OAAF,uBAAEA,OAAO,CAAEuB,MADL;AAEXC,MAAAA,MAAM,EAAE7B,YAAF,aAAEA,YAAF,uBAAEA,YAAY,CAAE6B,MAFX;AAGXC,MAAAA,OAAO,EAAEzB,OAAF,aAAEA,OAAF,uBAAEA,OAAO,CAAEyB,OAHP;AAIXC,MAAAA,YAAY,EAAE/B,YAAF,aAAEA,YAAF,uBAAEA,YAAY,CAAE+B,YAJjB;AAKXC,MAAAA,WAAW,EAAE,CAAAhC,YAAY,SAAZ,IAAAA,YAAY,WAAZ,YAAAA,YAAY,CAAE+B,YAAd,MAA+B,CAA/B,GAAmC,sBAAnC,GAA4D,yBAL9D;AAMXE,MAAAA,OAAO,EAAEjC,YAAF,aAAEA,YAAF,uBAAEA,YAAY,CAAEiC,OANZ;AAOXC,MAAAA,SAAS,EAAElC,YAAF,aAAEA,YAAF,uBAAEA,YAAY,CAAEkC;AAPd,KAAb;AASAzB,IAAAA,UAAU,CAAC,IAAD,CAAV;;AACA,QAAI;AACF,YAAM;AAAE0B,QAAAA,OAAF;AAAW5B,QAAAA,IAAX;AAAiB6B,QAAAA,OAAjB;AAA0BC,QAAAA;AAA1B,UAAqC,MAAM3C,eAAe,CAC9D8B,KAD8D,EAE9DL,MAF8D,CAAhE;;AAKA,UAAIiB,OAAO,KAAK,KAAZ,IAAqBC,MAAM,KAAK,KAApC,EAA2C;AACzC,YAAIC,GAAG,GAAG,EAAV;AACAA,QAAAA,GAAG,CAAClC,IAAJ,CAAS+B,OAAT;AACApB,QAAAA,WAAW,CAACuB,GAAD,CAAX;AACA7B,QAAAA,UAAU,CAAC,KAAD,CAAV;AACA;AACD;;AACDA,MAAAA,UAAU,CAAC,IAAD,CAAV;AACAE,MAAAA,iBAAiB,CAAC0B,MAAD,CAAjB;AACAxB,MAAAA,oBAAoB,CAACN,IAAD,CAApB;AACAQ,MAAAA,WAAW,CAAC,EAAD,CAAX;AACAN,MAAAA,UAAU,CAAC,KAAD,CAAV;AACD,KAlBD,CAkBE,OAAO8B,KAAP,EAAc;AACd9B,MAAAA,UAAU,CAAC,KAAD,CAAV;;AACA,UAAI8B,KAAK,IAAI,CAACA,KAAK,CAACC,QAApB,EAA8B;AAC5B,YAAIF,GAAG,GAAG,EAAV;AACAA,QAAAA,GAAG,CAAClC,IAAJ,CAAS,+CAAT;AACAW,QAAAA,WAAW,CAACuB,GAAD,CAAX;AACA;AACD;;AACD,UACEC,KAAK,KACJA,KAAK,CAACC,QAAN,CAAeH,MAAf,KAA0B,GAA1B,IACCE,KAAK,CAACC,QAAN,CAAeH,MAAf,KAA0B,GAD3B,IAECE,KAAK,CAACC,QAAN,CAAeH,MAAf,KAA0B,GAHvB,CADP,EAKE;AACA,YAAIC,GAAG,GAAG,EAAV;AACAA,QAAAA,GAAG,CAAClC,IAAJ,CAASmC,KAAK,CAACC,QAAN,CAAejC,IAAf,CAAoB4B,OAA7B;AACApB,QAAAA,WAAW,CAACuB,GAAD,CAAX;AACA;AACD;;AACD,YAAM;AACJE,QAAAA,QAAQ,EAAE;AAAEjC,UAAAA;AAAF;AADN,UAEFgC,KAFJ;AAGAhC,MAAAA,IAAI,CAACU,MAAL,IAAeD,YAAY,CAACT,IAAI,CAACU,MAAN,CAA3B;AACD;AACF,GArDsC,EAqDpC,CAACZ,OAAD,CArDoC,CAAvC;AAuDApB,EAAAA,SAAS,CAAC,MAAM;AACd,QAAI,CAAAoB,OAAO,SAAP,IAAAA,OAAO,WAAP,YAAAA,OAAO,CAAEuB,MAAT,KAAmB,CAAChB,iBAAxB,EAA2C;AACzCc,MAAAA,mBAAmB;AACpB;;AAED,QAAI,CAAArB,OAAO,SAAP,IAAAA,OAAO,WAAP,YAAAA,OAAO,CAAEuB,MAAT,KAAmBlB,cAAvB,EAAuC;AACrC,UAAI,CAAAE,iBAAiB,SAAjB,IAAAA,iBAAiB,WAAjB,YAAAA,iBAAiB,CAAEmB,YAAnB,MAAoC,CAAxC,EAA2CU,OAAO;;AAClD,UAAI,CAAA7B,iBAAiB,SAAjB,IAAAA,iBAAiB,WAAjB,YAAAA,iBAAiB,CAAEmB,YAAnB,MAAoC,CAAxC,EAA2C;AACzChC,QAAAA,KAAK,CAACI,OAAN,CAAcuC,OAAd,CAAsB;AACpBC,UAAAA,QAAQ,EAAE,cADU;AAEpB3C,UAAAA,YAAY,EAAE;AACZ6B,YAAAA,MAAM,EAAEjB,iBAAF,aAAEA,iBAAF,uBAAEA,iBAAiB,CAAEiB,MADf;AAEZe,YAAAA,OAAO,EAAEhC,iBAAF,aAAEA,iBAAF,uBAAEA,iBAAiB,CAAEqB;AAFhB;AAFM,SAAtB;AAOD;AACF;AACF,GAjBQ,EAiBN,CAACrB,iBAAD,EAAoBP,OAApB,CAjBM,CAAT;AAmBA,QAAM,CACJwC,eADI,EAEJ;AAAErC,IAAAA,SAAS,EAAEsC,gBAAb;AAA+BP,IAAAA,KAAK,EAAEQ,YAAtC;AAAoDxC,IAAAA,IAAI,EAAEyC;AAA1D,GAFI,IAGFzD,WAAW,CAACE,gBAAD,CAHf;AAKA,QAAMgD,OAAO,GAAGvD,WAAW,CAAC,YAAY;AACtC,QAAI;AACF,YAAM;AAAEiD,QAAAA,OAAF;AAAW5B,QAAAA,IAAX;AAAiB6B,QAAAA;AAAjB,UAA6B,MAAMS,eAAe,CAAC;AACvDrB,QAAAA,KADuD;AAEvDG,QAAAA,KAAK,EAAEtB,OAAO,CAACuB,MAFwC;AAGvDqB,QAAAA,eAAe,EAAErC,iBAAF,aAAEA,iBAAF,uBAAEA,iBAAiB,CAAEsB;AAHmB,OAAD,CAAxD;;AAMA,UAAI,CAACE,OAAL,EAAc;AACZ,cAAM,IAAIc,KAAJ,CAAUf,OAAV,CAAN;AACD;;AAEDpC,MAAAA,KAAK,CAACI,OAAN,CAAcuC,OAAd,CAAsB,QAAtB,EAAgC;AAAEP,QAAAA;AAAF,OAAhC;AACD,KAZD,CAYE,OAAOgB,GAAP,EAAY;AACZC,MAAAA,OAAO,CAACC,GAAR,CAAYF,GAAZ;AACA7B,MAAAA,uBAAuB,CAAC6B,GAAG,CAAChB,OAAL,CAAvB;AACD;AACF,GAjB0B,EAiBxB,CAAC9B,OAAD,EAAUmB,KAAV,EAAiBD,KAAjB,EAAwBsB,eAAxB,EAAyC1C,OAAzC,CAjBwB,CAA3B;;AAmBA,MAAIK,SAAS,IAAIsC,gBAAb,IAAiC,CAACzC,OAAO,CAACuB,MAA9C,EAAsD;AACpD,wBACE,uDACE;AAAK,MAAA,SAAS,EAAC,qEAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBACE;AACE,MAAA,GAAG,EAAC,sBADN;AAEE,MAAA,GAAG,EAAC,EAFN;AAGE,MAAA,SAAS,EAAC,oBAHZ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MADF,eAME;AAAI,MAAA,SAAS,EAAC,0CAAd;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,0DANF,CADF,CADF;AAcD;;AAED,MACEd,QAAQ,CAACwC,MAAT,GAAkB,CAAlB,IACAP,YADA,IAECnC,iBAAiB,IAAI,CAACA,iBAAiB,CAACyB,MAFzC,IAGCW,eAAe,IAAI,CAACA,eAAe,CAACX,MAJvC,EAKE;AACA,wBACE,uDACE;AAAM,MAAA,SAAS,EAAC,UAAhB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBACE;AAAK,MAAA,SAAS,EAAC,OAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBACE;AAAK,MAAA,SAAS,EAAC,SAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBACE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MADF,EAEGvB,QAAQ,CAACwC,MAAT,gBACC;AACE,MAAA,SAAS,EAAC,oHADZ;AAEE,MAAA,IAAI,EAAC,OAFP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBAIE;AAAK,MAAA,SAAS,EAAC,MAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBACE;AAAK,MAAA,SAAS,EAAC,MAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBACE;AACE,MAAA,SAAS,EAAC,wCADZ;AAEE,MAAA,KAAK,EAAC,4BAFR;AAGE,MAAA,OAAO,EAAC,WAHV;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBAKE;AAAM,MAAA,CAAC,EAAC,gJAAR;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MALF,CADF,CADF,eAUE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBAGE;AAAI,MAAA,KAAK,EAAE;AAAEC,QAAAA,aAAa,EAAE;AAAjB,OAAX;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OACGzC,QAAQ,CAAC0C,GAAT,CAAa,CAACjB,KAAD,EAAQkB,CAAR,kBACZ;AAAI,MAAA,GAAG,EAAEA,CAAT;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAAalB,KAAb,CADD,CADH,CAHF,CAVF,CAJF,CADD,GA2BC,EA7BJ,eA+BE;AAAK,MAAA,SAAS,EAAC,+HAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBACE;AAAK,MAAA,SAAS,EAAC,oBAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBACE;AACE,MAAA,GAAG,EAAC,qBADN;AAEE,MAAA,GAAG,EAAC,EAFN;AAGE,MAAA,SAAS,EAAC,uBAHZ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MADF,CADF,eAQE;AAAK,MAAA,SAAS,EAAC,uBAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBACE;AAAG,MAAA,SAAS,EAAC,uCAAb;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBACE;AAAM,MAAA,SAAS,EAAC,cAAhB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qCADF,EAGU,GAHV,eAIE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAJF,EAKG3B,iBAAiB,IAAIA,iBAAiB,CAACyB,MAAlB,KAA6B,KAAlD,GACGzB,iBAAiB,CAACuB,OADrB,GAEG,EAPN,EAQGY,YAAY,GACTA,YAAY,CAACP,QAAb,CAAsBH,MAAtB,GACA,KADA,GAEAU,YAAY,CAACP,QAAb,CAAsBjC,IAAtB,CAA2B4B,OAF3B,GAGA,GAHA,GAIAd,oBALS,GAMT,EAdN,EAeG2B,eAAe,IAAIA,eAAe,CAACX,MAAhB,KAA2B,KAA9C,GACG,CAAC,KAAD,GAASW,eAAe,CAACb,OAD5B,GAEG,EAjBN,EAkBGd,oBAAoB,GAAGA,oBAAH,GAA0B,IAlBjD,CADF,CARF,eA8BE;AAAK,MAAA,SAAS,EAAC,qBAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBACE;AACE,MAAA,OAAO,EAAE,MAAMtB,KAAK,CAACI,OAAN,CAAcuC,OAAd,CAAsB,GAAtB,CADjB;AAEE,MAAA,SAAS,EAAC,iMAFZ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBAIE;AACE,MAAA,SAAS,EAAC,YADZ;AAEE,MAAA,KAAK,EAAC,IAFR;AAGE,MAAA,MAAM,EAAC,IAHT;AAIE,MAAA,OAAO,EAAC,WAJV;AAKE,MAAA,IAAI,EAAC,MALP;AAME,MAAA,KAAK,EAAC,4BANR;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBAQE;AAAG,MAAA,EAAE,EAAC,mBAAN;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBACE;AACE,MAAA,EAAE,EAAC,mCADL;AAEE,MAAA,CAAC,EAAC,iFAFJ;AAGE,MAAA,IAAI,EAAC,OAHP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MADF,CARF,CAJF,eAoBE;AAAM,MAAA,SAAS,EAAC,oCAAhB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,sBApBF,CADF,CA9BF,CA/BF,CADF,CADF,CADF,CADF;AAiGD;;AAED,sBACE,uDACE;AAAM,IAAA,SAAS,EAAC,UAAhB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kBACE;AAAK,IAAA,SAAS,EAAC,OAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kBACE;AAAK,IAAA,SAAS,EAAC,SAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kBACE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IADF,eAEE;AAAK,IAAA,SAAS,EAAC,+HAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kBACE;AAAK,IAAA,SAAS,EAAC,oBAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kBACE;AACE,IAAA,GAAG,EAAC,qBADN;AAEE,IAAA,GAAG,EAAC,EAFN;AAGE,IAAA,SAAS,EAAC,uBAHZ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IADF,CADF,eAQE;AAAK,IAAA,SAAS,EAAC,uBAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kBACE;AAAG,IAAA,SAAS,EAAC,uCAAb;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kBACE;AAAM,IAAA,SAAS,EAAC,cAAhB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,0FAE6B1C,YAF7B,aAE6BA,YAF7B,uBAE6BA,YAAY,CAAEkC,SAF3C,CADF,CADF,CARF,CAFF,CADF,CADF,CADF,CADF;AA4BD,CApRD;;AAsRA,eAAe9C,UAAU,CAACU,eAAD,CAAzB","sourcesContent":["import React, { useState, useEffect, useCallback } from \"react\";\nimport { useLocation, withRouter } from \"react-router\";\nimport { useHistory } from \"react-router-dom\";\nimport useProfileStore from \"../stores/profileStore\";\nimport { useQuery, useMutation } from \"react-query\";\nimport useAuthStore from \"../stores/authStore\";\nimport { verifyPaymentReference, addCardToProfile } from \"../clients/cards\";\nimport { validatePayment } from \"../clients/payments\";\n\nfunction useQueryParams() {\n  return new URLSearchParams(useLocation().search);\n}\n\nconst PaymentCallback = (props: any) => {\n\n  let referrerData = props.location.referrerData;\n  if (\n    referrerData === null ||\n    referrerData === \"\" ||\n    referrerData === undefined\n  ) {\n    props.history.push(\"/pay\");\n  }\n\n  const profile: any = useProfileStore((state) => state.data);\n  const [isLoading, setLoading] = useState(false);\n  const [isPaymentValid, setIsPaymentValid] = useState(false);\n  const [verifyTrxResponse, setVerifyTrxResponse]: any = useState();\n  const [errorMsg, setErrorMsg] = useState([]);\n  const updateErrors = (errors: []) => {\n    setErrorMsg(Object.values(errors).flat());\n  };\n\n  const [addCardErrorResponse, setAddCardErrorResponse] = useState<any>();\n\n  let query = useQueryParams();\n\n  const history = useHistory();\n\n  const token = useAuthStore((state) => state.accessToken);\n\n  const confirmPaymentEntry = useCallback(async () => {\n    let values = {\n      email: profile?.e_mail,\n      amount: referrerData?.amount,\n      user_id: profile?.user_id,\n      payment_type: referrerData?.payment_type,\n      description: referrerData?.payment_type === 0 ? \"Card Pre-auth charge\" : \"Repayment with new card\",\n      item_id: referrerData?.item_id,\n      reference: referrerData?.reference,\n    };\n    setLoading(true);\n    try {\n      const { message, data, success, status } = await validatePayment(\n        token,\n        values\n      );\n\n      if (success === false || status === false) {\n        let msg = [] as any;\n        msg.push(message);\n        setErrorMsg(msg);\n        setLoading(false);\n        return;\n      }\n      setLoading(true);\n      setIsPaymentValid(status)\n      setVerifyTrxResponse(data);\n      setErrorMsg([]);\n      setLoading(false);\n    } catch (error) {\n      setLoading(false);\n      if (error && !error.response) {\n        let msg = [] as any;\n        msg.push(\"Network Error, Check Your Internet Connection\");\n        setErrorMsg(msg);\n        return;\n      }\n      if (\n        error &&\n        (error.response.status === 500 ||\n          error.response.status === 404 ||\n          error.response.status === 401)\n      ) {\n        let msg = [] as any;\n        msg.push(error.response.data.message);\n        setErrorMsg(msg);\n        return;\n      }\n      const {\n        response: { data },\n      } = error;\n      data.errors && updateErrors(data.errors);\n    }\n  }, [profile]);\n\n  useEffect(() => {\n    if (profile?.e_mail && !verifyTrxResponse) {\n      confirmPaymentEntry();\n    }\n\n    if (profile?.e_mail && isPaymentValid) {\n      if (verifyTrxResponse?.payment_type === 0) addCard();\n      if (verifyTrxResponse?.payment_type === 2) {\n        props.history.replace({\n          pathname: \"/pay/success\",\n          referrerData: {\n            amount: verifyTrxResponse?.amount,\n            loan_id: verifyTrxResponse?.item_id,\n          },\n        });\n      }\n    }\n  }, [verifyTrxResponse, profile]);\n\n  const [\n    addCardMutation,\n    { isLoading: isAddCardLoading, error: addCardError, data: addCardResponse },\n  ] = useMutation(addCardToProfile);\n\n  const addCard = useCallback(async () => {\n    try {\n      const { message, data, success } = await addCardMutation({\n        token,\n        email: profile.e_mail,\n        transaction_ref: verifyTrxResponse?.reference,\n      });\n\n      if (!success) {\n        throw new Error(message);\n      }\n\n      props.history.replace(\"/cards\", { message });\n    } catch (err) {\n      console.log(err);\n      setAddCardErrorResponse(err.message);\n    }\n  }, [profile, token, query, addCardMutation, history]);\n\n  if (isLoading || isAddCardLoading || !profile.e_mail) {\n    return (\n      <>\n        <div className=\"w-11/12 bg-white rounded py-12 shadow-lg m-auto px-8 relative mt-20\">\n          <img\n            src=\"/img/loading-gif.gif\"\n            alt=\"\"\n            className=\"w-1/8 m-auto py-10\"\n          />\n          <h6 className=\"m-auto text-lg text-gray-700 text-center\">\n            Please wait. We are verifying the transaction...\n          </h6>\n        </div>\n      </>\n    );\n  }\n\n  if (\n    errorMsg.length > 0 ||\n    addCardError ||\n    (verifyTrxResponse && !verifyTrxResponse.status) ||\n    (addCardResponse && !addCardResponse.status)\n  ) {\n    return (\n      <>\n        <main className=\"md:pl-12\">\n          <div className=\"flex \">\n            <div className=\"w-full \">\n              <br />\n              {errorMsg.length ? (\n                <div\n                  className=\"w-11/12 bg-red-100 border-t-4 border-red-500 rounded-b text-red-900 px-4 py-3 shadow-md mb-5 m-auto md:m-0 md:mb-2\"\n                  role=\"alert\"\n                >\n                  <div className=\"flex\">\n                    <div className=\"py-1\">\n                      <svg\n                        className=\"fill-current h-6 w-6 text-red-500 mr-4\"\n                        xmlns=\"http://www.w3.org/2000/svg\"\n                        viewBox=\"0 0 20 20\"\n                      >\n                        <path d=\"M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zm12.73-1.41A8 8 0 1 0 4.34 4.34a8 8 0 0 0 11.32 11.32zM9 11V9h2v6H9v-4zm0-6h2v2H9V5z\" />\n                      </svg>\n                    </div>\n                    <div>\n                      {/* <p className=\"font-bold\">Sent successfully</p> */}\n                      {/* <p className=\"text-sm\">{errorMsg}</p> */}\n                      <ul style={{ listStyleType: \"none\" }}>\n                        {errorMsg.map((error, i) => (\n                          <li key={i}>{error}</li>\n                        ))}\n                      </ul>\n                    </div>\n                  </div>\n                </div>\n              ) : (\n                \"\"\n              )}\n              <div className=\"relative w-11/12 bg-white rounded py-12 shadow-lg border-b-4 border-blue-700 md:border-none mb-20 m-auto md:m-0 mt-12 md:mt-0\">\n                <div className=\"w-full m-auto mb-6\">\n                  <img\n                    src=\"/img/error-icon.svg\"\n                    alt=\"\"\n                    className=\"w-2/4 md:w-1/4 m-auto\"\n                  />\n                </div>\n                <div className=\"w-3/4 md:w-2/4 m-auto\">\n                  <p className=\"text-gray-700 font-medium text-center\">\n                    <span className=\"text-red-600\">\n                      Oops! An error has occured.\n                    </span>{\" \"}\n                    <br />\n                    {verifyTrxResponse && verifyTrxResponse.status === false\n                      ? verifyTrxResponse.message\n                      : \"\"}\n                    {addCardError\n                      ? addCardError.response.status +\n                        \" - \" +\n                        addCardError.response.data.message +\n                        \" \" +\n                        addCardErrorResponse\n                      : \"\"}\n                    {addCardResponse && addCardResponse.status === false\n                      ? +\" - \" + addCardResponse.message\n                      : \"\"}\n                    {addCardErrorResponse ? addCardErrorResponse : null}\n                  </p>\n                </div>\n                <div className=\"w-full m-auto mt-10\">\n                  <button\n                    onClick={() => props.history.replace(\"/\")}\n                    className=\"flex w-2/4 md:w-1/4 shadow-xl text-xl font-light text-white justify-center py-4 md:py-3 items-center bg-gray-800 hover:bg-gray-700 rounded-md m-auto transition-colors duration-150 ease-in-out\"\n                  >\n                    <svg\n                      className=\"mr-2 -mt-1\"\n                      width=\"18\"\n                      height=\"18\"\n                      viewBox=\"0 0 18 18\"\n                      fill=\"none\"\n                      xmlns=\"http://www.w3.org/2000/svg\"\n                    >\n                      <g id=\"chevron_left_24px\">\n                        <path\n                          id=\"icon/navigation/chevron_left_24px\"\n                          d=\"M15.705 16.59L11.125 12L15.705 7.41L14.295 6L8.29498 12L14.295 18L15.705 16.59Z\"\n                          fill=\"white\"\n                        />\n                      </g>\n                    </svg>\n                    <span className=\"text-sm xl:text-lg lg:text-sm pr-2\">\n                      Back to home\n                    </span>\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </main>\n      </>\n    );\n  }\n\n  return (\n    <>\n      <main className=\"md:pl-12\">\n        <div className=\"flex \">\n          <div className=\"w-full \">\n            <br />\n            <div className=\"relative w-11/12 bg-white rounded py-12 shadow-lg border-b-4 border-blue-700 md:border-none mb-20 m-auto md:m-0 mt-12 md:mt-0\">\n              <div className=\"w-full m-auto mb-6\">\n                <img\n                  src=\"/img/error-icon.svg\"\n                  alt=\"\"\n                  className=\"w-2/4 md:w-1/4 m-auto\"\n                />\n              </div>\n              <div className=\"w-3/4 md:w-2/4 m-auto\">\n                <p className=\"text-gray-700 font-medium text-center\">\n                  <span className=\"text-red-600\">\n                    Fatal exception. Please reach out to the administrator\n                    immediately! Payment ref: {referrerData?.reference}\n                  </span>\n                </p>\n              </div>\n            </div>\n          </div>\n        </div>\n      </main>\n    </>\n  );\n};\n\nexport default withRouter(PaymentCallback);\n"]},"metadata":{},"sourceType":"module"}